<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Keyboard & Mouse Tester（鍵盤滑鼠檢測工具）</title>
<style>
:root {
  --bg: #0f172a;
  --panel: #111827;
  --card: #1f2937;
  --accent: #8b5cf6;
  --accent-2: #22d3ee;
  --text: #e5e7eb;
  --muted: #94a3b8;
  --border: #1e293b;
  --danger: #ef4444;
  --success: #22c55e;
  --shadow: 0 10px 40px rgba(0,0,0,0.25);
  --radius: 14px;
}
* { box-sizing: border-box; }
body {
  margin: 0;
  background: radial-gradient(circle at 20% 20%, rgba(34,211,238,0.05), transparent 35%),
              radial-gradient(circle at 80% 10%, rgba(139,92,246,0.08), transparent 40%),
              radial-gradient(circle at 70% 80%, rgba(236,72,153,0.05), transparent 40%),
              var(--bg);
  color: var(--text);
  font-family: 'Inter', system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
  min-height: 100vh;
}
header {
  padding: 24px 20px 12px;
  max-width: 1320px;
  margin: 0 auto;
}
.container {
  max-width: 1400px;
  margin: 0 auto;
  padding: 0 20px 40px;
}
.h1 { font-size: clamp(28px, 3vw, 38px); font-weight: 800; margin: 0 0 8px; }
.sub { color: var(--muted); margin: 0; font-size: 14px; }
.card {
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 18px;
  box-shadow: var(--shadow);
}
.tabs { display: flex; gap: 8px; margin-top: 18px; flex-wrap: wrap; }
.tab {
  border: 1px solid var(--border);
  background: var(--panel);
  color: var(--text);
  padding: 10px 16px;
  border-radius: var(--radius);
  cursor: pointer;
  transition: all .2s ease;
  font-weight: 700;
}
.tab.active { background: linear-gradient(135deg, var(--accent), var(--accent-2)); color: #0b0f1c; box-shadow: 0 10px 30px rgba(139,92,246,0.25); }
.tab-content { display: none; margin-top: 16px; }
.tab-content.active { display: block; }
.flex { display: flex; gap: 16px; }
.grid-2 { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 16px; }
.button {
  background: var(--accent);
  color: #0b0f1c;
  font-weight: 700;
  border: none;
  border-radius: 12px;
  padding: 10px 16px;
  cursor: pointer;
  box-shadow: 0 10px 30px rgba(139,92,246,0.3);
  transition: transform .1s ease, box-shadow .2s ease;
}
.button.secondary { background: var(--panel); color: var(--text); border: 1px solid var(--border); box-shadow: none; }
.button:active { transform: translateY(2px); box-shadow: 0 6px 14px rgba(0,0,0,0.3); }
.badge { background: rgba(255,255,255,0.06); border: 1px solid var(--border); padding: 4px 10px; border-radius: 12px; font-size: 12px; color: var(--muted); }
.status-row { display: flex; flex-wrap: wrap; gap: 8px; }
.status-pill { background: rgba(255,255,255,0.05); border: 1px solid var(--border); padding: 8px 12px; border-radius: 12px; min-width: 90px; text-align: center; }
.status-pill.active { border-color: var(--accent); color: var(--accent); box-shadow: inset 0 0 0 1px rgba(139,92,246,0.5); }
.virtual-keyboard { background: var(--panel); border: 1px solid var(--border); border-radius: var(--radius); padding: 18px; box-shadow: inset 0 1px 0 rgba(255,255,255,0.05); width: 100%; min-width: 1080px; }
.keyboard-wrap { background: linear-gradient(135deg, rgba(139,92,246,0.08), rgba(34,211,238,0.08)); padding: 16px; border-radius: calc(var(--radius) + 2px); border: 1px solid var(--border); box-shadow: inset 0 1px 0 rgba(255,255,255,0.04), 0 20px 60px rgba(0,0,0,0.25); overflow-x: auto; }
.virtual-keyboard { max-width: 100%; margin: 0 auto; }
.key-row { display: flex; gap: 10px; margin-bottom: 10px; flex-wrap: nowrap; }
.key { flex: 1 1 62px; min-height: 54px; border-radius: 12px; background: linear-gradient(180deg, #1f2937, #0b1220); border: 1px solid var(--border); color: var(--text); font-weight: 800; letter-spacing: 0.3px; cursor: pointer; position: relative; overflow: hidden; transition: all .12s ease; }
.key span { position: relative; z-index: 2; }
.key::after { content: ''; position: absolute; inset: 0; background: linear-gradient(135deg, rgba(139,92,246,0.2), rgba(34,211,238,0.18)); opacity: 0; transition: opacity .2s ease; }
.key:hover { transform: translateY(-1px); box-shadow: 0 10px 20px rgba(0,0,0,0.35); }
.key.pressed { border-color: var(--accent); color: var(--accent); box-shadow: 0 0 0 2px rgba(139,92,246,0.3), inset 0 0 0 1px rgba(34,211,238,0.2); }
.key.pressed::after { opacity: 1; }
.key.wide-15 { flex: 1.5; }
.key.wide-175 { flex: 1.75; }
.key.wide-2 { flex: 2; }
.key.wide-225 { flex: 2.25; }
.key.wide-25 { flex: 2.5; }
.key.wide-6 { flex: 6; }
.keyboard-shell { display:flex; flex-direction:column; gap:14px; }
.keyboard-topbar { display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:12px; }
.keyboard-meta { display:flex; align-items:center; gap:12px; flex-wrap:wrap; }
.keyboard-hint { background: rgba(255,255,255,0.04); border:1px dashed var(--border); padding:10px 12px; border-radius:12px; color: var(--muted); font-size:13px; }
.keyboard-wrap::-webkit-scrollbar { height: 10px; }
.keyboard-wrap::-webkit-scrollbar-thumb { background: rgba(139,92,246,0.35); border-radius: 6px; }
.keyboard-wrap::-webkit-scrollbar-track { background: rgba(255,255,255,0.04); border-radius: 6px; }
.keyboard-wrap { scrollbar-color: rgba(139,92,246,0.35) rgba(255,255,255,0.04); scrollbar-width: thin; }
.info { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 10px; }
.info-item { background: var(--panel); border: 1px solid var(--border); padding: 10px; border-radius: 12px; font-size: 13px; color: var(--muted); }
.info-item strong { color: var(--text); display: block; margin-bottom: 6px; font-size: 14px; }
.virtual-mouse { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; align-items: stretch; }
.mouse-body { position: relative; height: 320px; background: var(--panel); border-radius: 26px; border: 1px solid var(--border); box-shadow: inset 0 1px 0 rgba(255,255,255,0.05); overflow: hidden; }
.mouse-zone { position: absolute; inset: 0; display: grid; grid-template-rows: repeat(5, 1fr); grid-template-columns: repeat(2, 1fr); }
.mouse-btn { border: 1px solid var(--border); background: rgba(255,255,255,0.02); color: var(--text); display: flex; align-items: center; justify-content: center; font-weight: 700; cursor: pointer; transition: all .12s ease; }
.mouse-btn:hover { background: rgba(139,92,246,0.08); }
.mouse-btn.active { background: rgba(139,92,246,0.2); color: var(--accent); box-shadow: inset 0 0 0 1px rgba(139,92,246,0.6); }
.wheel-panel { display: grid; grid-template-columns: repeat(3, 1fr); grid-template-rows: repeat(3, 1fr); gap: 8px; }
.stat-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 12px; }
.stat-card { background: var(--panel); border: 1px solid var(--border); padding: 12px; border-radius: 12px; }
.stat-card h4 { margin: 0 0 6px; font-size: 14px; color: var(--muted); }
.stat-card .value { font-size: 22px; font-weight: 800; }
.log { max-height: 220px; overflow: auto; border: 1px solid var(--border); border-radius: 12px; background: var(--panel); padding: 10px; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace; font-size: 12px; }
.log-entry { border-bottom: 1px solid var(--border); padding: 4px 0; color: var(--muted); }
.log-entry:last-child { border-bottom: none; }
.label { display: inline-flex; align-items: center; gap: 6px; color: var(--muted); font-size: 13px; }
input, select { background: var(--panel); color: var(--text); border: 1px solid var(--border); border-radius: 8px; padding: 8px 10px; width: 100%; }
.toggle { display: flex; align-items: center; gap: 10px; }
.small { font-size: 12px; color: var(--muted); }
.keyboard-layout { display:grid; grid-template-columns: minmax(0,1.8fr) minmax(320px, 0.95fr); gap: 18px; align-items:start; }
.side-card { position: sticky; top: 14px; }
@media (max-width: 1280px) {
  .keyboard-layout { grid-template-columns: minmax(0,1.6fr) minmax(320px, 1fr); }
  .virtual-keyboard { min-width: 980px; }
}
@media (max-width: 1100px) {
  .keyboard-layout { grid-template-columns: 1fr; }
  .side-card { position: relative; top: 0; }
  .virtual-keyboard { min-width: 860px; }
}
@media (max-width: 768px) {
  .flex { flex-direction: column; }
  .virtual-mouse { grid-template-columns: 1fr; }
  .virtual-keyboard { min-width: 720px; }
  .keyboard-wrap { padding: 12px; }
  .key { min-height: 48px; }
}
</style>
</head>
<body>
<header>
  <div class="badge">Keyboard & Mouse Tester（鍵盤滑鼠檢測工具）</div>
  <h1 class="h1">鍵盤滑鼠檢測工具</h1>
  <p class="sub">純前端單頁，支援虛擬元件與真實輸入，適用 GitHub Pages。觸控裝置可用虛擬元件，實體鍵鼠功能視裝置支援度而定。</p>
  <div class="tabs">
    <button class="tab active" data-tab="keyboard">鍵盤</button>
    <button class="tab" data-tab="mouse">滑鼠</button>
    <button class="tab" data-tab="stats">統計</button>
    <button class="tab" data-tab="settings">設定</button>
  </div>
</header>
<div class="container">
  <section id="keyboard" class="tab-content active">
    <div class="keyboard-layout">
      <div class="card">
        <div class="keyboard-shell">
          <div class="keyboard-topbar">
            <div class="keyboard-meta">
              <div class="label">虛擬鍵盤 · 點擊等同鍵盤輸入</div>
              <div class="keyboard-hint">桌機建議使用全螢幕，鍵帽更寬、指示更清楚；若螢幕較小可橫向捲動。</div>
            </div>
            <div class="flex" style="gap:8px;">
              <button id="start-test" class="button">開始測試</button>
              <button class="button secondary" id="reset-keyboard">重置</button>
            </div>
          </div>
          <div class="keyboard-wrap">
            <div id="keyboard-board" class="virtual-keyboard"></div>
          </div>
        </div>
      </div>
      <div class="card side-card" style="min-width:320px;">
        <div class="label" style="margin-bottom:10px;">即時按鍵資訊</div>
        <div class="info">
          <div class="info-item"><strong>Key</strong><span id="info-key">—</span></div>
          <div class="info-item"><strong>Code</strong><span id="info-code">—</span></div>
          <div class="info-item"><strong>Repeat</strong><span id="info-repeat">—</span></div>
          <div class="info-item"><strong>來源</strong><span id="info-source">—</span></div>
          <div class="info-item"><strong>時間戳</strong><span id="info-time">—</span></div>
          <div class="info-item"><strong>按下中的鍵</strong><span id="info-pressed">—</span></div>
        </div>
        <div style="margin-top:14px;">
          <div class="label" style="margin-bottom:6px;">修飾鍵狀態</div>
          <div class="status-row">
            <div class="status-pill" id="mod-Shift">Shift</div>
            <div class="status-pill" id="mod-Control">Ctrl</div>
            <div class="status-pill" id="mod-Alt">Alt</div>
            <div class="status-pill" id="mod-Meta">Meta</div>
            <div class="status-pill" id="mod-CapsLock">CapsLock</div>
            <div class="status-pill" id="mod-NumLock">NumLock</div>
          </div>
        </div>
        <div style="margin-top:14px;">
          <div class="label" style="margin-bottom:6px;">鍵盤測試模式</div>
          <div class="card" style="padding:10px; background: var(--panel); border:1px dashed var(--border);">
            <div class="info" style="grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));">
              <div class="info-item"><strong>下一個</strong><span id="test-target">—</span></div>
              <div class="info-item"><strong>完成率</strong><span id="test-progress">—</span></div>
              <div class="info-item"><strong>剩餘</strong><span id="test-remaining">—</span></div>
              <div class="info-item"><strong>漏按</strong><span id="test-missed">—</span></div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>
  <section id="mouse" class="tab-content">
    <div class="flex" style="align-items:flex-start;">
      <div class="card" style="flex:3;">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
          <div class="label">虛擬滑鼠 · 點擊區塊即可模擬滑鼠事件</div>
          <button class="button secondary" id="reset-mouse">重置</button>
        </div>
        <div class="virtual-mouse">
          <div class="mouse-body">
            <div class="mouse-zone">
              <div class="mouse-btn" data-btn="left" style="grid-row:1/3; grid-column:1/2; border-right:none;">左鍵</div>
              <div class="mouse-btn" data-btn="right" style="grid-row:1/3; grid-column:2/3; border-left:none;">右鍵</div>
              <div class="mouse-btn" data-btn="middle" style="grid-row:3/4; grid-column:1/3;">中鍵</div>
              <div class="mouse-btn" data-btn="wheel-up" style="grid-row:4/5; grid-column:1/2;">滾輪 ↑</div>
              <div class="mouse-btn" data-btn="wheel-down" style="grid-row:4/5; grid-column:2/3;">滾輪 ↓</div>
              <div class="mouse-btn" data-btn="wheel-left" style="grid-row:5/6; grid-column:1/2;">滾輪 ←</div>
              <div class="mouse-btn" data-btn="wheel-right" style="grid-row:5/6; grid-column:2/3;">滾輪 →</div>
            </div>
          </div>
          <div class="card" style="height:100%;">
            <div class="info" style="grid-template-columns: repeat(auto-fit, minmax(180px,1fr));">
              <div class="info-item"><strong>座標</strong><span id="mouse-pos">—</span></div>
              <div class="info-item"><strong>速度</strong><span id="mouse-speed">—</span></div>
              <div class="info-item"><strong>按鍵 bitmask</strong><span id="mouse-buttons">—</span></div>
              <div class="info-item"><strong>點擊次數</strong><span id="mouse-clicks">—</span></div>
              <div class="info-item"><strong>雙擊</strong><span id="mouse-dbl">—</span></div>
              <div class="info-item"><strong>滾動量</strong><span id="mouse-wheel">—</span></div>
              <div class="info-item"><strong>來源</strong><span id="mouse-source">—</span></div>
            </div>
          </div>
        </div>
      </div>
      <div class="card" style="flex:2; min-width:260px;">
        <div class="label" style="margin-bottom:6px;">滑鼠統計</div>
        <div class="stat-grid">
          <div class="stat-card"><h4>總點擊</h4><div class="value" id="stat-m-total">0</div></div>
          <div class="stat-card"><h4>左 / 中 / 右</h4><div class="value" id="stat-m-breakdown">0 / 0 / 0</div></div>
          <div class="stat-card"><h4>雙擊次數</h4><div class="value" id="stat-m-dbl">0</div></div>
          <div class="stat-card"><h4>移動距離(px)</h4><div class="value" id="stat-m-distance">0</div></div>
          <div class="stat-card"><h4>平均速度(px/s)</h4><div class="value" id="stat-m-speed">0</div></div>
          <div class="stat-card"><h4>滾動量 (X / Y)</h4><div class="value" id="stat-m-wheel">0 / 0</div></div>
          <div class="stat-card"><h4>來源比例</h4><div class="value" id="stat-m-source">—</div></div>
        </div>
      </div>
    </div>
  </section>
  <section id="stats" class="tab-content">
    <div class="flex" style="align-items:flex-start;">
      <div class="card" style="flex:3;">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
          <div class="label">統計儀表板</div>
          <button class="button secondary" id="reset-stats">重置</button>
        </div>
        <div class="stat-grid">
          <div class="stat-card"><h4>鍵盤總按鍵</h4><div class="value" id="stat-k-total">0</div></div>
          <div class="stat-card"><h4>不同按鍵數</h4><div class="value" id="stat-k-unique">0</div></div>
          <div class="stat-card"><h4>Top 10</h4><div class="value small" id="stat-k-top">—</div></div>
          <div class="stat-card"><h4>平均按住時間(ms)</h4><div class="value" id="stat-k-hold">0</div></div>
          <div class="stat-card"><h4>最快連發間隔(ms)</h4><div class="value" id="stat-k-fast">—</div></div>
          <div class="stat-card"><h4>來源比例</h4><div class="value" id="stat-k-source">—</div></div>
          <div class="stat-card"><h4>滑鼠來源比例</h4><div class="value" id="stat-m-source-2">—</div></div>
        </div>
      </div>
      <div class="card" style="flex:2; min-width:280px;">
        <div class="label" style="margin-bottom:10px;">匯出</div>
        <p class="small">下載 JSON 包含統計與最近事件 Log。</p>
        <button class="button" id="download-json">下載 JSON</button>
        <div class="label" style="margin-top:12px;">來源比例</div>
        <div class="info" style="grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));">
          <div class="info-item"><strong>鍵盤</strong><span id="source-k">—</span></div>
          <div class="info-item"><strong>滑鼠</strong><span id="source-m">—</span></div>
        </div>
      </div>
    </div>
  </section>
  <section id="settings" class="tab-content">
    <div class="card">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
        <div class="label">設定</div>
        <button class="button secondary" id="reset-all">全部重置</button>
      </div>
      <div class="grid-2">
        <div class="card" style="background: var(--panel); border:1px dashed var(--border);">
          <div class="toggle">
            <input type="checkbox" id="toggle-log"/> <label for="toggle-log">開啟 Raw Event Log</label>
          </div>
          <div style="margin-top:8px;">
            <label class="label" for="log-size">Log 保留筆數</label>
            <select id="log-size">
              <option value="100">100</option>
              <option value="300" selected>300</option>
              <option value="1000">1000</option>
            </select>
          </div>
          <div style="margin-top:8px;" class="toggle">
            <input type="checkbox" id="toggle-context"/> <label for="toggle-context">阻止右鍵選單</label>
          </div>
        </div>
        <div class="card" style="background: var(--panel); border:1px dashed var(--border);">
          <div class="flex" style="gap:10px; flex-wrap:wrap;">
            <button class="button secondary" id="clear-stats">清除統計</button>
            <button class="button secondary" id="clear-log">清除 Log</button>
            <button class="button secondary" id="reset-state">重置狀態</button>
          </div>
          <p class="small" style="margin-top:8px;">重置與清除不會送出任何資料，所有狀態皆存於前端。</p>
        </div>
      </div>
    </div>
  </section>
  <section class="card" id="log-panel" style="margin-top:18px;">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:6px;">
      <div class="label">事件 Log（最近 N 筆）</div>
      <span class="badge" id="log-count">0</span>
    </div>
    <div class="log" id="log-list"></div>
  </section>
</div>
<script>
// State Store
const store = {
  settings: { rawLog: true, logSize: 300, preventContext: true },
  events: [],
  keyboard: {
    pressed: new Set(),
    holdStart: new Map(),
    lastEvent: null,
    modifiers: { Shift:false, Control:false, Alt:false, Meta:false, CapsLock:false, NumLock:false },
    counts: new Map(),
    testMode: { active: false, targets: ['KeyA','KeyS','KeyD','KeyF','Space','Enter','ArrowUp','ArrowDown','ArrowLeft','ArrowRight'], index: 0, missed: [] },
    lastPressTime: null,
    intervals: []
  },
  mouse: {
    buttons: 0,
    lastEvent: null,
    position: { x: 0, y: 0 },
    lastMoveTime: null,
    speed: 0,
    distance: 0,
    clickCounts: { left:0, middle:0, right:0, double:0 },
    wheel: { x:0, y:0 },
    sourceCounts: { virtual:0, physical:0 }
  },
  stats: {
    keyboard: { total:0, unique:new Set(), holdDurations: [], fastest: Infinity, sourceCounts:{ virtual:0, physical:0 } },
    mouse: { totalClicks:0, left:0, middle:0, right:0, double:0, distance:0, speedSamples: [], wheelX:0, wheelY:0, sourceCounts:{ virtual:0, physical:0 } }
  }
};

let renderPending = false;
const requestRender = () => { if(!renderPending){ renderPending = true; requestAnimationFrame(render); } };

function emitEvent(type, payload){
  const entry = { type, ...payload, timestamp: payload.timestamp || Date.now() };
  if(store.settings.rawLog){
    store.events.push(entry);
    if(store.events.length > store.settings.logSize){
      store.events.splice(0, store.events.length - store.settings.logSize);
    }
  }
  updateStateFromEvent(entry);
  requestRender();
}

function updateStateFromEvent(evt){
  if(evt.type === 'keydown'){
    const { code, key, repeat, source } = evt;
    store.keyboard.pressed.add(code);
    if(!store.keyboard.holdStart.has(code)) store.keyboard.holdStart.set(code, evt.timestamp);
    const prevTime = store.keyboard.lastPressTime;
    if(prevTime){
      store.keyboard.intervals.push(evt.timestamp - prevTime);
      if(store.keyboard.intervals.length > 1000) store.keyboard.intervals.shift();
    }
    store.keyboard.lastPressTime = evt.timestamp;
    store.stats.keyboard.total++;
    store.stats.keyboard.unique.add(code);
    const count = store.keyboard.counts.get(code) || 0;
    store.keyboard.counts.set(code, count+1);
    store.stats.keyboard.sourceCounts[source] = (store.stats.keyboard.sourceCounts[source]||0)+1;
    store.keyboard.lastEvent = evt;
    updateModifiers(evt);
    handleTestMode(code);
  }
  if(evt.type === 'keyup'){
    const start = store.keyboard.holdStart.get(evt.code);
    if(start){
      const duration = evt.timestamp - start;
      store.stats.keyboard.holdDurations.push(duration);
      if(store.stats.keyboard.holdDurations.length>1000) store.stats.keyboard.holdDurations.shift();
    }
    store.keyboard.holdStart.delete(evt.code);
    store.keyboard.pressed.delete(evt.code);
    store.keyboard.lastEvent = evt;
    updateModifiers(evt);
  }
  if(evt.type === 'mouse'){
    store.mouse.lastEvent = evt;
    store.mouse.position = { x: evt.clientX ?? 0, y: evt.clientY ?? 0 };
    store.mouse.buttons = evt.buttons ?? store.mouse.buttons;
    store.mouse.speed = evt.speed ?? store.mouse.speed;
    store.mouse.distance += evt.deltaDistance || 0;
    store.stats.mouse.distance = store.mouse.distance;
    if(evt.subtype === 'move' && typeof evt.speed === 'number'){
      store.stats.mouse.speedSamples.push(evt.speed);
      if(store.stats.mouse.speedSamples.length>500) store.stats.mouse.speedSamples.shift();
    }
    if(evt.subtype === 'down'){
      const btn = evt.button;
      if(btn===0){ store.mouse.clickCounts.left++; store.stats.mouse.left++; }
      if(btn===1){ store.mouse.clickCounts.middle++; store.stats.mouse.middle++; }
      if(btn===2){ store.mouse.clickCounts.right++; store.stats.mouse.right++; }
      store.stats.mouse.totalClicks++;
      store.stats.mouse.sourceCounts[evt.source] = (store.stats.mouse.sourceCounts[evt.source]||0)+1;
    }
    if(evt.subtype === 'dblclick'){
      store.mouse.clickCounts.double++; store.stats.mouse.double++; }
    if(evt.subtype === 'wheel'){
      store.mouse.wheel.x += evt.deltaX || 0; store.mouse.wheel.y += evt.deltaY || 0;
      store.stats.mouse.wheelX += evt.deltaX || 0; store.stats.mouse.wheelY += evt.deltaY || 0;
      store.stats.mouse.sourceCounts[evt.source] = (store.stats.mouse.sourceCounts[evt.source]||0)+1;
    }
  }
}

function updateModifiers(evt){
  const modKeys = ['Shift','Control','Alt','Meta','CapsLock','NumLock'];
  modKeys.forEach(mod=>{
    if(evt.getModifierState){
      store.keyboard.modifiers[mod] = evt.getModifierState(mod);
    } else if(evt.code === `${mod}` || evt.code === `${mod}Left` || evt.code === `${mod}Right`){
      if(mod === 'CapsLock' || mod === 'NumLock'){
        store.keyboard.modifiers[mod] = !store.keyboard.modifiers[mod];
      } else {
        store.keyboard.modifiers[mod] = evt.type === 'keydown';
      }
    }
  });
}

// Keyboard Layout
const keyboardLayout = [
  [ {label:'Esc', code:'Escape'}, {label:'F1',code:'F1'}, {label:'F2',code:'F2'}, {label:'F3',code:'F3'}, {label:'F4',code:'F4'}, {label:'F5',code:'F5'}, {label:'F6',code:'F6'}, {label:'F7',code:'F7'}, {label:'F8',code:'F8'}, {label:'F9',code:'F9'}, {label:'F10',code:'F10'}, {label:'F11',code:'F11'}, {label:'F12',code:'F12'}, {label:'PrtSc',code:'PrintScreen'}, {label:'Del',code:'Delete'} ],
  [ {label:'` ~',code:'Backquote'}, {label:'1',code:'Digit1'}, {label:'2',code:'Digit2'}, {label:'3',code:'Digit3'}, {label:'4',code:'Digit4'}, {label:'5',code:'Digit5'}, {label:'6',code:'Digit6'}, {label:'7',code:'Digit7'}, {label:'8',code:'Digit8'}, {label:'9',code:'Digit9'}, {label:'0',code:'Digit0'}, {label:'- _',code:'Minus'}, {label:'= +',code:'Equal'}, {label:'Backspace',code:'Backspace', width:'225'} ],
  [ {label:'Tab',code:'Tab', width:'15'}, {label:'Q',code:'KeyQ'}, {label:'W',code:'KeyW'}, {label:'E',code:'KeyE'}, {label:'R',code:'KeyR'}, {label:'T',code:'KeyT'}, {label:'Y',code:'KeyY'}, {label:'U',code:'KeyU'}, {label:'I',code:'KeyI'}, {label:'O',code:'KeyO'}, {label:'P',code:'KeyP'}, {label:'[ {',code:'BracketLeft'}, {label:'] }',code:'BracketRight'}, {label:'\\ |',code:'Backslash', width:'175'} ],
  [ {label:'CapsLock',code:'CapsLock', width:'175'}, {label:'A',code:'KeyA'}, {label:'S',code:'KeyS'}, {label:'D',code:'KeyD'}, {label:'F',code:'KeyF'}, {label:'G',code:'KeyG'}, {label:'H',code:'KeyH'}, {label:'J',code:'KeyJ'}, {label:'K',code:'KeyK'}, {label:'L',code:'KeyL'}, {label:'; :',code:'Semicolon'}, {label:"' \"",code:'Quote'}, {label:'Enter',code:'Enter', width:'225'} ],
  [ {label:'Shift',code:'ShiftLeft', width:'225'}, {label:'Z',code:'KeyZ'}, {label:'X',code:'KeyX'}, {label:'C',code:'KeyC'}, {label:'V',code:'KeyV'}, {label:'B',code:'KeyB'}, {label:'N',code:'KeyN'}, {label:'M',code:'KeyM'}, {label:', <',code:'Comma'}, {label:'. >',code:'Period'}, {label:'/?',code:'Slash'}, {label:'Shift',code:'ShiftRight', width:'25'} ],
  [ {label:'Ctrl',code:'ControlLeft', width:'15'}, {label:'Win',code:'MetaLeft'}, {label:'Alt',code:'AltLeft'}, {label:'Space',code:'Space', width:'6'}, {label:'Alt',code:'AltRight'}, {label:'Menu',code:'ContextMenu'}, {label:'Ctrl',code:'ControlRight', width:'15'}, {label:'←',code:'ArrowLeft'}, {label:'↑',code:'ArrowUp'}, {label:'↓',code:'ArrowDown'}, {label:'→',code:'ArrowRight'} ],
  [ {label:'NumLock',code:'NumLock'}, {label:'/',code:'NumpadDivide'}, {label:'*',code:'NumpadMultiply'}, {label:'-',code:'NumpadSubtract'}, {label:'7',code:'Numpad7'}, {label:'8',code:'Numpad8'}, {label:'9',code:'Numpad9'}, {label:'+',code:'NumpadAdd', width:'15'}, {label:'4',code:'Numpad4'}, {label:'5',code:'Numpad5'}, {label:'6',code:'Numpad6'}, {label:'1',code:'Numpad1'}, {label:'2',code:'Numpad2'}, {label:'3',code:'Numpad3'}, {label:'0',code:'Numpad0', width:'2'}, {label:'.',code:'NumpadDecimal'}, {label:'Enter',code:'NumpadEnter'} ]
];

const keyboardBoard = document.getElementById('keyboard-board');
const keyElements = new Map();
function renderKeyboard(){
  keyboardBoard.innerHTML = '';
  keyboardLayout.forEach(row=>{
    const rowEl = document.createElement('div');
    rowEl.className = 'key-row';
    row.forEach(key=>{
      const btn = document.createElement('button');
      btn.className = 'key';
      if(key.width){ btn.classList.add(`wide-${key.width}`); }
      btn.dataset.code = key.code;
      btn.innerHTML = `<span>${key.label}</span>`;
      btn.addEventListener('click', ()=> simulateKeyPress(key));
      keyElements.set(key.code, btn);
      rowEl.appendChild(btn);
    });
    keyboardBoard.appendChild(rowEl);
  });
}

function simulateKeyPress(key){
  const timestamp = Date.now();
  emitEvent('keydown', { key: key.label, code: key.code, repeat:false, source:'virtual', timestamp });
  setTimeout(()=>{
    emitEvent('keyup', { key: key.label, code: key.code, repeat:false, source:'virtual', timestamp: Date.now() });
  }, 140);
}

function handlePhysicalKey(e){
  if(e && typeof e.preventDefault === 'function') e.preventDefault();
  emitEvent(e.type === 'keydown' ? 'keydown':'keyup', {
    key: e.key,
    code: e.code,
    repeat: e.repeat,
    source:'physical',
    timestamp: e.timeStamp,
    getModifierState: e.getModifierState.bind(e)
  });
}

function handleTestMode(code){
  const tm = store.keyboard.testMode;
  if(!tm.active) return;
  const target = tm.targets[tm.index];
  if(code === target){
    tm.index++;
    if(tm.index >= tm.targets.length){ tm.active = false; }
  } else {
    tm.missed.push(code);
  }
}

// Mouse
const mouseButtons = document.querySelectorAll('.mouse-btn');
mouseButtons.forEach(btn=>{
  btn.addEventListener('mousedown', ()=>{
    const type = btn.dataset.btn;
    if(type.startsWith('wheel')){
      const delta = type.includes('up') ? -120 : type.includes('down') ? 120 : type.includes('left') ? -120 : 120;
      const payload = { deltaY: (type==='wheel-up'||type==='wheel-down') ? delta : 0, deltaX: (type==='wheel-left'||type==='wheel-right') ? delta : 0 };
      emitEvent('mouse', { subtype:'wheel', ...payload, source:'virtual', timestamp: Date.now() });
      activateMouse(btn, 120);
      return;
    }
    const buttonMap = { left:0, middle:1, right:2 };
    emitEvent('mouse', { subtype:'down', button: buttonMap[type], buttons:1<<buttonMap[type], source:'virtual', timestamp: Date.now() });
    activateMouse(btn);
    setTimeout(()=>{
      emitEvent('mouse', { subtype:'up', button: buttonMap[type], buttons:0, source:'virtual', timestamp: Date.now() });
      emitEvent('mouse', { subtype:'click', button: buttonMap[type], buttons:0, source:'virtual', timestamp: Date.now() });
      deactivateMouse(btn);
    }, 140);
  });
});

function activateMouse(el, duration=300){ el.classList.add('active'); if(duration) setTimeout(()=>el.classList.remove('active'), duration); }
function deactivateMouse(el){ el.classList.remove('active'); }

function handleMouseMove(e){
  const now = performance.now();
  if(store.mouse.lastMoveTime){
    const dt = Math.max(1, now - store.mouse.lastMoveTime);
    const dx = e.clientX - store.mouse.position.x;
    const dy = e.clientY - store.mouse.position.y;
    const dist = Math.hypot(dx, dy);
    const speed = dist / dt * 1000;
    emitEvent('mouse', { subtype:'move', clientX:e.clientX, clientY:e.clientY, speed: Math.round(speed), deltaDistance: dist, buttons: e.buttons, source:'physical', timestamp: e.timeStamp });
  }
  store.mouse.lastMoveTime = now;
  store.mouse.position = { x:e.clientX, y:e.clientY };
}
function handleMouseDown(e){ emitEvent('mouse', { subtype:'down', button:e.button, buttons:e.buttons, clientX:e.clientX, clientY:e.clientY, source:'physical', timestamp:e.timeStamp, getModifierState: e.getModifierState?.bind(e) }); }
function handleMouseUp(e){ emitEvent('mouse', { subtype:'up', button:e.button, buttons:e.buttons, clientX:e.clientX, clientY:e.clientY, source:'physical', timestamp:e.timeStamp }); }
function handleClick(e){ emitEvent('mouse', { subtype:'click', button:e.button, buttons:e.buttons, clientX:e.clientX, clientY:e.clientY, source:'physical', timestamp:e.timeStamp }); }
function handleDblClick(e){ emitEvent('mouse', { subtype:'dblclick', button:e.button, buttons:e.buttons, clientX:e.clientX, clientY:e.clientY, source:'physical', timestamp:e.timeStamp }); }
function handleWheel(e){ emitEvent('mouse', { subtype:'wheel', deltaX:e.deltaX, deltaY:e.deltaY, buttons:e.buttons, clientX:e.clientX, clientY:e.clientY, source:'physical', timestamp:e.timeStamp }); }

// Rendering
function render(){
  renderPending = false;
  // highlight keys
  keyElements.forEach((el, code)=>{
    el.classList.toggle('pressed', store.keyboard.pressed.has(code));
  });
  // last key info
  const last = store.keyboard.lastEvent;
  document.getElementById('info-key').textContent = last?.key ?? '—';
  document.getElementById('info-code').textContent = last?.code ?? '—';
  document.getElementById('info-repeat').textContent = last?.repeat ? '是' : '否';
  document.getElementById('info-source').textContent = last?.source ?? '—';
  document.getElementById('info-time').textContent = last ? new Date(last.timestamp).toLocaleTimeString() : '—';
  document.getElementById('info-pressed').textContent = [...store.keyboard.pressed].join(', ') || '—';
  Object.entries(store.keyboard.modifiers).forEach(([k,v])=>{
    const el = document.getElementById(`mod-${k}`);
    if(el) el.classList.toggle('active', !!v);
  });
  // test mode
  const tm = store.keyboard.testMode;
  const remaining = Math.max(tm.targets.length - tm.index, 0);
  const progress = tm.targets.length ? Math.round((tm.index / tm.targets.length)*100) : 0;
  document.getElementById('test-target').textContent = tm.active ? tm.targets[tm.index] || '完成' : '尚未開始';
  document.getElementById('test-progress').textContent = `${progress}%`;
  document.getElementById('test-remaining').textContent = `${remaining}`;
  document.getElementById('test-missed').textContent = tm.missed.join(', ') || '—';
  // mouse info
  const m = store.mouse;
  document.getElementById('mouse-pos').textContent = `${Math.round(m.position.x)}, ${Math.round(m.position.y)}`;
  document.getElementById('mouse-speed').textContent = `${Math.round(m.speed)} px/s`;
  document.getElementById('mouse-buttons').textContent = m.buttons.toString();
  document.getElementById('mouse-clicks').textContent = `${m.clickCounts.left + m.clickCounts.middle + m.clickCounts.right}`;
  document.getElementById('mouse-dbl').textContent = `${m.clickCounts.double}`;
  document.getElementById('mouse-wheel').textContent = `${m.wheel.x} / ${m.wheel.y}`;
  document.getElementById('mouse-source').textContent = m.lastEvent?.source || '—';
  // stats
  document.getElementById('stat-m-total').textContent = store.stats.mouse.totalClicks;
  document.getElementById('stat-m-breakdown').textContent = `${store.stats.mouse.left} / ${store.stats.mouse.middle} / ${store.stats.mouse.right}`;
  document.getElementById('stat-m-dbl').textContent = store.stats.mouse.double;
  document.getElementById('stat-m-distance').textContent = store.stats.mouse.distance.toFixed(1);
  const avgSpeed = store.stats.mouse.speedSamples.length ? (store.stats.mouse.speedSamples.reduce((a,b)=>a+b,0)/store.stats.mouse.speedSamples.length) : 0;
  document.getElementById('stat-m-speed').textContent = avgSpeed.toFixed(1);
  document.getElementById('stat-m-wheel').textContent = `${Math.round(store.stats.mouse.wheelX)} / ${Math.round(store.stats.mouse.wheelY)}`;
  const mouseSourceTotal = store.stats.mouse.sourceCounts.virtual + store.stats.mouse.sourceCounts.physical || 0;
  const mouseSourceText = mouseSourceTotal ? `Virtual ${Math.round(store.stats.mouse.sourceCounts.virtual/mouseSourceTotal*100)}% / Physical ${Math.round(store.stats.mouse.sourceCounts.physical/mouseSourceTotal*100)}%` : '—';
  document.getElementById('stat-m-source').textContent = mouseSourceText;
  document.getElementById('stat-m-source-2').textContent = mouseSourceText;

  document.getElementById('stat-k-total').textContent = store.stats.keyboard.total;
  document.getElementById('stat-k-unique').textContent = store.stats.keyboard.unique.size;
  const topKeys = [...store.keyboard.counts.entries()].sort((a,b)=>b[1]-a[1]).slice(0,10).map(([k,v])=>`${k}:${v}`).join(' · ');
  document.getElementById('stat-k-top').textContent = topKeys || '—';
  const avgHold = store.stats.keyboard.holdDurations.length ? (store.stats.keyboard.holdDurations.reduce((a,b)=>a+b,0)/store.stats.keyboard.holdDurations.length) : 0;
  document.getElementById('stat-k-hold').textContent = avgHold.toFixed(1);
  const fastest = store.keyboard.intervals.length ? Math.min(...store.keyboard.intervals).toFixed(1) : '—';
  document.getElementById('stat-k-fast').textContent = fastest;
  const keyboardSourceTotal = store.stats.keyboard.sourceCounts.virtual + store.stats.keyboard.sourceCounts.physical || 0;
  const keyboardSourceText = keyboardSourceTotal ? `Virtual ${Math.round(store.stats.keyboard.sourceCounts.virtual/keyboardSourceTotal*100)}% / Physical ${Math.round(store.stats.keyboard.sourceCounts.physical/keyboardSourceTotal*100)}%` : '—';
  document.getElementById('stat-k-source').textContent = keyboardSourceText;
  document.getElementById('source-k').textContent = keyboardSourceText;
  document.getElementById('source-m').textContent = mouseSourceText;

  // mouse highlight
  mouseButtons.forEach(btn=>{
    const type = btn.dataset.btn;
    if(type === 'left') btn.classList.toggle('active', !!(m.buttons & 1));
    if(type === 'right') btn.classList.toggle('active', !!(m.buttons & 2));
    if(type === 'middle') btn.classList.toggle('active', !!(m.buttons & 4));
  });

  // log
  const logPanel = document.getElementById('log-panel');
  logPanel.style.display = store.settings.rawLog ? 'block' : 'none';
  document.getElementById('log-size').value = store.settings.logSize;
  document.getElementById('toggle-log').checked = store.settings.rawLog;
  document.getElementById('toggle-context').checked = store.settings.preventContext;
  const list = document.getElementById('log-list');
  list.innerHTML = '';
  store.events.slice().reverse().forEach(evt=>{
    const div = document.createElement('div');
    div.className = 'log-entry';
    const time = new Date(evt.timestamp).toLocaleTimeString();
    div.textContent = `[${time}] ${evt.type.toUpperCase()} ${evt.code||evt.subtype||''} src=${evt.source||'n/a'} `;
    list.appendChild(div);
  });
  document.getElementById('log-count').textContent = store.events.length;
}

// Tabs
const tabs = document.querySelectorAll('.tab');
tabs.forEach(tab=>tab.addEventListener('click', ()=>{
  tabs.forEach(t=>t.classList.remove('active'));
  document.querySelectorAll('.tab-content').forEach(c=>c.classList.remove('active'));
  tab.classList.add('active');
  document.getElementById(tab.dataset.tab).classList.add('active');
}));

// Settings actions
const resetKeyboardBtn = document.getElementById('reset-keyboard');
const resetMouseBtn = document.getElementById('reset-mouse');
const resetStatsBtn = document.getElementById('reset-stats');
const resetAllBtn = document.getElementById('reset-all');
const clearLogBtn = document.getElementById('clear-log');
const clearStatsBtn = document.getElementById('clear-stats');
const resetStateBtn = document.getElementById('reset-state');
const logSizeSelect = document.getElementById('log-size');
const toggleLog = document.getElementById('toggle-log');
const toggleContext = document.getElementById('toggle-context');

resetKeyboardBtn.addEventListener('click', ()=>{
  store.keyboard.pressed.clear();
  store.keyboard.holdStart.clear();
  store.keyboard.lastEvent = null;
  store.keyboard.modifiers = { Shift:false, Control:false, Alt:false, Meta:false, CapsLock:false, NumLock:false };
  requestRender();
});
resetMouseBtn.addEventListener('click', ()=>{
  store.mouse.buttons = 0; store.mouse.clickCounts = {left:0,middle:0,right:0,double:0}; store.mouse.wheel={x:0,y:0}; store.mouse.distance=0; store.mouse.speed=0; store.mouse.lastEvent=null; requestRender();
});
resetStatsBtn.addEventListener('click', ()=>{ store.stats.keyboard.total=0; store.stats.keyboard.unique.clear(); store.stats.keyboard.holdDurations=[]; store.keyboard.counts.clear(); store.keyboard.intervals=[]; store.stats.keyboard.sourceCounts={virtual:0,physical:0}; store.stats.mouse={ totalClicks:0,left:0,middle:0,right:0,double:0,distance:0,speedSamples:[],wheelX:0,wheelY:0,sourceCounts:{virtual:0,physical:0} }; requestRender(); });
resetAllBtn.addEventListener('click', ()=>{ store.events=[]; store.settings={ rawLog:true, logSize:300, preventContext:true }; resetKeyboardBtn.click(); resetMouseBtn.click(); resetStatsBtn.click(); requestRender(); });
clearLogBtn.addEventListener('click', ()=>{ store.events=[]; requestRender(); });
clearStatsBtn.addEventListener('click', ()=>{ resetStatsBtn.click(); });
resetStateBtn.addEventListener('click', ()=>{ resetKeyboardBtn.click(); resetMouseBtn.click(); });
logSizeSelect.addEventListener('change', ()=>{ store.settings.logSize = Number(logSizeSelect.value); if(store.events.length>store.settings.logSize){ store.events.splice(0, store.events.length - store.settings.logSize); } requestRender(); });
toggleLog.addEventListener('change', ()=>{ store.settings.rawLog = toggleLog.checked; requestRender(); });
toggleContext.addEventListener('change', ()=>{ store.settings.preventContext = toggleContext.checked; });
document.addEventListener('contextmenu', (e)=>{ if(store.settings.preventContext) e.preventDefault(); });

// Keyboard test mode
const startTestBtn = document.getElementById('start-test');
startTestBtn.addEventListener('click', ()=>{
  store.keyboard.testMode.active = true;
  store.keyboard.testMode.index = 0;
  store.keyboard.testMode.missed = [];
  requestRender();
});

// Download
const downloadBtn = document.getElementById('download-json');
downloadBtn.addEventListener('click', ()=>{
  const data = {
    generatedAt: new Date().toISOString(),
    stats: {
      keyboard: { total: store.stats.keyboard.total, unique: [...store.stats.keyboard.unique], avgHold: store.stats.keyboard.holdDurations, fastest: store.keyboard.intervals },
      mouse: store.stats.mouse
    },
    events: store.events
  };
  const blob = new Blob([JSON.stringify(data,null,2)], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = 'keyboard-mouse-tester.json'; a.click();
  URL.revokeObjectURL(url);
});

// Event listeners
window.addEventListener('keydown', handlePhysicalKey);
window.addEventListener('keyup', handlePhysicalKey);
window.addEventListener('mousemove', handleMouseMove);
window.addEventListener('mousedown', handleMouseDown);
window.addEventListener('mouseup', handleMouseUp);
window.addEventListener('click', handleClick);
window.addEventListener('dblclick', handleDblClick);
window.addEventListener('wheel', handleWheel, { passive: true });

renderKeyboard();
requestRender();
</script>
</body>
</html>